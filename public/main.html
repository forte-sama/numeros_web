<div class="col s12 m10 offset-m1 l8 offset-l2">
    <div class="card hoverable light-blue accent-4">
        <div class="card-content">
            <div class="right-align">
                <!-- Dropdown Trigger -->
                <a class='dropdown-button btn-flat btn-large' href='#' data-activates='dropdownMenu'>
                    <i class="material-icons">menu</i>
                </a>
                <!-- Dropdown Structure -->
                <ul id='dropdownMenu' class='dropdown-content'>
                    <li>
                        <a id="signout" class="light-blue-text text-accent-4" href="#">Sign Out</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="card-tabs">
            <ul class="tabs tabs-fixed-width light-blue accent-4">
                <li class="tab"><a id="tab_3dias" href="#_3dias" class="active white-text">Numeros por 3 dias</a></li>
                <li class="tab"><a id="tab_base_dia" href="#_base_dia" class="white-text">Base del dia</a></li>
                <div class="indicator black" style="z-index:1"></div>
            </ul>
        </div>
        <div class="card-content white">
            <div id="_3dias" class="col s12 m12 l12">
                <form id="_3dias">
                    <div class="row">
                        <div class="input-field col s2 m2 l2">
                            <label>Desde: </label>
                        </div>
                        <div class="input-field col s4 m4 l4">
                            <input type="date" name="fecha" class="validate">
                        </div>
                        <div class="input-field col s2 m2 l2">
                            <label>Hasta: </label>
                        </div>
                        <div class="input-field col s4 m4 l4">
                            <input type="date" name="fecha" class="validate">
                        </div>
                    </div>            
                    <div class="row">
                        <div class="input-field col s3 m3 l3">
                            <input type="number" name="numero_3dia" class="validate" min="0" max="99">
                        </div>
                        <div class="input-field col s3 m3 l3">
                            <input type="number" name="numero_3dia" class="validate" min="0" max="99">
                        </div>
                        <div class="input-field col s3 m3 l3">
                            <input type="number" name="numero_3dia" class="validate" min="0" max="99">
                        </div>
                        <div class="input-field col s3 m3 l3">
                            <input type="number" name="numero_3dia" class="validate" min="0" max="99">
                        </div>
                    </div>
                </form>
            </div>
            <div id="_base_dia" class="col s12 m12 l12">
                KLK BASE DEL DIA
            </div>
        </div>
        <div class="card-content white">
            <div class="row">
                <div class="col s10 offset-s1 m8 offset-m2 l6 offset-l3 center-align">
                    <a id="btn_publish" href="#" class="btn btn-large light-blue darken-3 waves-effect waves-light">
                        ...
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    moment().locale("es");
    var current = "tab_3dias";

    $(document).ready(function() {
        const db = firebase.database();

        // boton para publicar
        const btn_publish = $("#btn_publish");

        function submitNumeros3Dias() {
            // obtener valor de todos los inputs relevantes
            var ifechas = $("form#_3dias input[name=fecha]");
            var fechas = {
                inicio: ifechas.get(0).value,
                fin: ifechas.get(1).value
            };
            var inumeros = $("form#_3dias input[type=number]");
            var numeros = [inumeros.get(0).value * 1,inumeros.get(1).value * 1,
                           inumeros.get(2).value * 1,inumeros.get(3).value * 1];

            // validar y transformar fechas a formato user friendly
            var fechasValidas = true;
            // fechas seran validas cuando la inicial sea antes que la final, y ambas sean fechas validas
            fechasValidas     = moment(fechas.inicio).isBefore(moment(fechas.fin));
            
            if(fechasValidas) {
                fechas.inicio = moment(fechas.inicio).format("dddd D, MMMM YYYY");
                fechas.fin    = moment(fechas.fin).format("dddd D, MMMM YYYY");
            }

            // validar numeros
            var numerosValidos = true;
            var arregloNumerosValidos = numeros.filter((n) => { return n >= 0 && n <= 99; });
            var todosEstanEnRango = arregloNumerosValidos.length === numeros.length;
            var conteoDeOcurrencias = [];
            numeros.forEach((x) => {
                if(conteoDeOcurrencias[x]) {
                    conteoDeOcurrencias[x]++;
                }
                else {
                    conteoDeOcurrencias[x] = 1;
                }
            });
            var numerosSeRepiten = conteoDeOcurrencias.find((x) => { return x > 1; }) != undefined;
            // numeros seran validos cuando todos esten en el rango jugable y no hayan repetidos
            numerosValidos = todosEstanEnRango && !numerosSeRepiten;

            // subirlos
            if(fechasValidas && numerosValidos) {
                // subir nuevos datos a db
                db.ref("/_3dias").set({
                    desde: fechas.inicio,
                    hasta: fechas.fin,
                    numeros: numeros
                }).then(function() {
                    // nitificar a usuario
                    Materialize.toast("Se publicaron los nuevos numeros!", 5670);

                    $("input[name=fecha]").removeClass("invalid").addClass("valid");
                });
            }
            else {
                // mostrar errores
                Materialize.toast("Favor de verificar e intentar de nuevo.", 15431);
                // errores de las fechas
                if(!fechasValidas) {
                    $("input[name=fecha]").removeClass("valid").addClass("invalid");
                    Materialize.toast("Las fechas no son validas.", 15431);
                }
                // errores de los numeros
                if(!numerosValidos) {
                    if(!todosEstanEnRango) {
                        Materialize.toast("Algunos numeros se pasan del rango jugable.", 15431);                    
                    }
                    if(numerosSeRepiten) {
                        Materialize.toast("Algunos numeros se repiten. (Campo vacio es 00)", 15431);                    
                    }
                }                
            }
        }

        function submitBaseDelDia() {
            // obtener valor de todos los inputs relevantes
            // validarlos
                // validar fechas
                // validar numeros
            // subirlos
        }

        btn_publish.click(function(e) {
            e.preventDefault();
            
            if(current === "tab_3dias") {
                submitNumeros3Dias();
            }
            else if(current === "tab_base_dia") {
                submitBaseDelDia();
            }
        });

        // cambiar valor de tab actual siempre
        function changeCurrentTab(value) {
            current = value;

            if (current === "tab_3dias") {
                btn_publish.text("Publicar numeros 3 dias");
            }
            else if (current === "tab_base_dia") {
                btn_publish.text("Publicar base del dia");
            }
        }
        $("li.tab a").click(function(e) {
            var newValue = $(this).attr("id");
            changeCurrentTab(newValue);
        });
        
        // corroborar tab actual
        changeCurrentTab($("li.tab a.active").attr("id"));

        // activar dropdowns
        $('.dropdown-button').dropdown({
            constrainWidth: true
        });
        
        // activar tabs
        $("ul.tabs").tabs();

        // activar boton de cierre de sesion
        $("#signout").click(function(e) {
            e.preventDefault();

            firebase.auth().signOut();
        });
    });
</script>